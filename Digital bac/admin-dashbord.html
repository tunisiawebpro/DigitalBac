<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Digital Bac</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #f5f5f5;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 260px;
      background: #6C4AB6;
      color: white;
      padding: 2rem 1rem;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.5rem;
    }
    .sidebar ul {
      list-style: none;
    }
    .sidebar ul li {
      margin-bottom: 1rem;
    }
    .sidebar ul li a {
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      display: block;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: background 0.3s;
    }
    .sidebar ul li a:hover {
      background: #8D72E1;
    }
    .main {
      margin-right: 260px;
      padding: 2rem;
      width: 100%;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .topbar h1 {
      font-size: 1.8rem;
      color: #333;
    }
    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #c0392b;
    }
    .card {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.07);
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
}
.card .icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  color: #6C4AB6;
}
.card.users .icon { color: #6C4AB6; }
.card.subjects .icon { color: #3498db; }
.card.videos .icon { color: #f39c12; }
.card.quizzes .icon { color: #e74c3c; }
    @media (max-width: 768px) {
      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
      }
      .main {
        margin-right: 0;
      }
    }
    .users-table-section {
  background: #70416c;
  border-radius: 12px;
  padding: 1rem;
  margin-top: 2rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

#usersTable {
  width: 100%;
  border-collapse: collapse;
}

#usersTable th, #usersTable td {
  border: 1px solid #ddd;
  padding: 0.75rem;
  text-align: center;
}

#usersTable th {
  background-color: var(--primary);
  color: white;
}

.delete-btn {
  background-color: var(--error);
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
}

.delete-btn:hover {
  background-color: #e60000;
}
.add-user-btn {
  background-color: #4BB543;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 0.95rem;
}

.add-user-btn:hover {
  background-color: #3da436;
}
.edit-btn {
  background-color: #1e1bc4; /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± */
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 5px;
}

.edit-btn:hover {
  background-color: #399934;
}
.modal-overlay {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.modal-content h3 {
  margin-bottom: 1rem;
  color: #6C4AB6;
}

.modal-content label {
  display: block;
  margin-top: 1rem;
  margin-bottom: 5px;
  font-weight: 600;
}

.modal-actions {
  margin-top: 1.5rem;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.save-btn {
  background-color: #4BB543;
}

.cancel-btn {
  background-color: #e74c3c;
}
.subjects-list {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem; margin-top: 1.5rem;
    }
    .subject-card {
      background: #a018b3; padding: 1rem; border-radius: 12px;
      display: flex; align-items: center; gap: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .subject-card i {
      font-size: 1.5rem; color: #6C4AB6;
    }
    .subject-card span {
      font-weight: 600; color: #333;
    }
     .modal input {
    border: 1px solid #aa1ac7;
    border-radius: 5px;
  }
  .modal button {
    margin-left: 10px;
    padding: 5px 10px;
    background-color: #2b6cb0;
    color: rgb(135, 20, 170);
    border: none;
    border-radius: 5px;
  }
  @media (max-width: 768px) {
  .sidebar {
    display: none;
  }
}

.payments-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    overflow-x: auto;
  }
  
  .payments-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  
  .payments-table th, 
  .payments-table td {
    padding: 0.75rem;
    text-align: center;
    border: 1px solid #ddd;
  }
  
  .payments-table th {
    background-color: #6C4AB6;
    color: white;
  }
  
  .payments-table tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  .btn-success {
    background-color: #4BB543;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    margin: 0 3px;
  }
  
  .btn-danger {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    margin: 0 3px;
  }
  
  .payment-status-pending {
    color: #f39c12;
  }
  
  .payment-status-success {
    color: #4BB543;
  }
  
  .payment-status-refused {
    color: #e74c3c;
  }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>
    <ul>
      <li><a href="#">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©</a></li>
      <li><a href="#">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a></li>
      <li><a href="#">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</a></li>
      <li><a href="#">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</a></li>
      <li><a href="#">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</a></li>
      <li><a href="#">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¶</a></li>
      <li><a href="#">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</a></li>
    </ul>
  </div>

  <div class="main">
  <div class="topbar">
    <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ Ù…Ø´Ø±Ù</h1>
    <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="cards" id="mainDashboard">
  <div class="card users">
    <div class="icon"><i class="fas fa-users"></i></div>
    <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <p id="userCount">--</p>
  </div>
  <div class="card subjects">
    <div class="icon"><i class="fas fa-book-open"></i></div>
    <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
    <p id="subjectCount">0</p>
  </div>
  <div class="card videos">
    <div class="icon"><i class="fas fa-video"></i></div>
    <h3>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
    <p id="videoCount">--</p>
  </div>
  <div class="card quizzes">
    <div class="icon"><i class="fas fa-file-alt"></i></div>
    <h3>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙˆØ¶</h3>
    <p id="quizCount">--</p>
  </div>
</div>
<section class="users-table-section" id="manageUsersSection" style="display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
    <button class="add-user-btn" onclick="showAddUserForm()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
  </div>
   <table id="usersTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø±Ù‚Ù…</th>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
        <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="usersTableBody">
      <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ù… Ù‡Ù†Ø§ Ø¹Ø¨Ø± JavaScript -->
    </tbody>
  </table>
</section>
<section class="users-table-section" id="manageSubjectsSection" style="display: none;">
  <h2 style="margin-bottom: 1rem;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</h2>

  <label for="section">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
  <select id="sectionSelector" onchange="loadSubjectsForSection()" style="margin-bottom: 1rem; padding: 0.5rem;">
    <option value="">Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø©</option>
    <option value="math">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
    <option value="science">Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©</option>
    <option value="eco">Ø§Ù‚ØªØµØ§Ø¯ ÙˆØªØµØ±Ù</option>
    <option value="lettres">Ø¢Ø¯Ø§Ø¨</option>
    <option value="tech">ØªÙ‚Ù†ÙŠØ©</option>
    <option value="info">Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©</option>
  </select>
  
    <div style="display: flex; justify-content: space-between; align-items: center;">
  <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
  <button onclick="showAddSubjectForm()" class="add-user-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
</div>

<table id="usersTable" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
  <thead>
  <tr>
    <th>Ø§Ù„Ø±Ù‚Ù…</th>
    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
    <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
  </tr>
</thead>
  <tbody id="subjectsTableBody">
    <!-- Ø§Ù„Ù…ÙˆØ§Ø¯ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
  </tbody>
</table>
</section>

<section class="payments-section" id="managePaymentsSection" style="display: none;">
  <h2>Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</h2>
  <div class="table-responsive">
  <table class="payments-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
        <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="admin-payments-body">
      <tr><td colspan="8" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
    </tbody>
  </table>
</section>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function logout() {
      Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: 'Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }
      });
    }

  
  async function fetchUserCount() {
    try {
      const response = await fetch('http://localhost:5000/api/admin/user-count');
      const data = await response.json();
      document.getElementById('userCount').textContent = data.count;
    } catch (error) {
      console.error('Error fetching user count:', error);
    }
  }

  async function fetchSubjectCount() {
    try {
      const res = await fetch('http://localhost:5000/api/admin/stats/subjects');
      const data = await res.json();
      document.getElementById('subjectCount').textContent = data.total;
    } catch (err) {
      console.error('Error fetching subject count:', err);
    }
  }
  // Use DOMContentLoaded to safely run both
  document.addEventListener("DOMContentLoaded", function () {
    fetchUserCount();
    fetchSubjectCount();  

    // Static for now
    document.getElementById('videoCount').textContent = '34';
    document.getElementById('quizCount').textContent = '16';

    // Welcome toast
    Toastify({
      text: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù",
      duration: 3000,
      gravity: "top",
      position: "center",
      backgroundColor: "linear-gradient(to right, #6C4AB6, #8D72E1)",
    }).showToast();
  });

    async function fetchUsers() {
    try {
      const response = await fetch('http://localhost:5000/api/admin/users');
      const users = await response.json();

      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      users.forEach((user, index) => {
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${index + 1}</td>
    <td>${user.name}</td>
    <td>${user.email}</td>
    <td>${user.section || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}</td>
    <td>${user.phone || '---'}</td>
    <td>
  <button class="edit-btn" onclick="openEditModal(${user.id}, '${user.name}', '${user.email}', '${user.section || ''}', '${user.phone || ''}')">ØªØ¹Ø¯ÙŠÙ„</button>
  <button class="delete-btn" onclick="deleteUser(${user.id})">Ø­Ø°Ù</button>
</td>
  `;
  tbody.appendChild(row);
});

    } catch (err) {
      console.error('Error fetching users:', err);
    }
  }

  async function deleteUser(userId) {
    const confirmDelete = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ');
    if (!confirmDelete) return;

    try {
      const response = await fetch(`http://localhost:5000/api/admin/users/${userId}`, {
        method: 'DELETE',
      });

      const result = await response.json();
      alert(result.message);
      fetchUsers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    } catch (err) {
      console.error('Error deleting user:', err);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    fetchUserCount();
    fetchUsers();
  });

  // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
document.querySelectorAll('.sidebar ul li a').forEach(link => {
  link.addEventListener('click', (e) => {
    const text = e.target.textContent.trim();
    const dashboard = document.getElementById('mainDashboard');
    const usersSection = document.getElementById('manageUsersSection');
    const paymentSection = document.getElementById('managePaymentSection')

    if (text === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†') {
      dashboard.style.display = 'none';
      usersSection.style.display = 'block';
    } else {
      dashboard.style.display = 'block';
      usersSection.style.display = 'none';
    }
  });
});

// Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function showAddUserForm() {
  document.getElementById('addUserModal').style.display = 'flex';
}
function hideAddUserForm() {
  document.getElementById('addUserModal').style.display = 'none';
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
async function createUser() {
  const name = document.getElementById('newUserName').value.trim();
  const email = document.getElementById('newUserEmail').value.trim();
  const password = document.getElementById('newUserPassword').value.trim();
  const section = document.getElementById('newUserSection').value.trim();
  const phone = document.getElementById('newUserPhone').value.trim();

  if (!name || !email || !password) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
    return;
  }

  try {
    const res = await fetch('http://localhost:5000/api/admin/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password, section, phone })
    });

    const data = await res.json();
    alert(data.message || 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    hideAddUserForm();
    fetchUsers();
  } catch (err) {
    alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    console.error(err);
  }
}
// Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙˆØµ (Ø®Ø§ØµÙŠØ© Ø§Ù„Ø£Ù…Ø§Ù†)
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>
  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… -->
<div id="addUserModal" style="display: none; background-color: rgba(0,0,0,0.6); position: fixed; top: 0; right: 0; width: 100%; height: 100%; justify-content: center; align-items: center;">
  <div style="background: rgb(134, 25, 116); padding: 2rem; border-radius: 12px; width: 400px;">
    <h3 style="margin-bottom: 1rem;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
    <input type="text" id="newUserName" placeholder="Ø§Ù„Ø§Ø³Ù…" class="form-control" style="margin-bottom: 1rem; width: 100%;" />
    <input type="email" id="newUserEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="form-control" style="margin-bottom: 1rem; width: 100%;" />
    <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="form-control" style="margin-bottom: 1rem; width: 100%;" />
    <input type="text" id="newUserSection" placeholder="Ø§Ù„Ø´Ø¹Ø¨Ø©" class="form-control" style="margin-bottom: 1rem; width: 100%;" />
    <input type="text" id="newUserPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="form-control" style="margin-bottom: 1rem; width: 100%;" />
    <div style="display: flex; justify-content: space-between;">
      <button onclick="createUser()" class="btn">Ø¥Ù†Ø´Ø§Ø¡</button>
      <button onclick="hideAddUserForm()" class="btn logout-btn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>
<!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div id="editModal" class="modal-overlay">
  <div class="modal-content">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <form id="editForm">
      <input type="hidden" id="editUserId" />

      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
      <input type="text" id="editUserName" class="form-control" required />

      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
      <input type="email" id="editUserEmail" class="form-control" required />

      <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
      <input type="text" id="editUserSection" class="form-control" />

      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
      <input type="text" id="editUserPhone" class="form-control" />

      <div class="modal-actions">
        <button type="submit" class="btn save-btn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button type="button" class="btn cancel-btn" onclick="closeEditModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>
</div>
<div id="addSubjectModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <form onsubmit="createSubject(event)">
      <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
      <select id="newSubjectSection" required>
  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© --</option>
  <option value="math">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
  <option value="science">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
  <option value="eco">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯</option>
  <option value="tech">Ø´Ø¹Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©</option>
  <option value="lettres">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¢Ø¯Ø§Ø¨</option>
  <option value="info">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©</option>
</select>

      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
      <input type="text" id="newSubjectName" required />

      <div class="modal-actions">
        <button type="submit" class="btn save-btn">Ø¥Ø¶Ø§ÙØ©</button>
        <button type="button" class="btn cancel-btn" onclick="closeAddSubjectModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>
</div>
<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø© -->
<div id="subjectModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="subjectModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</h3>
    <input type="hidden" id="editSubjectId" />
    <label for="subjectName">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
    <input type="text" id="subjectName" class="form-control" />

    <div class="modal-actions">
      <button onclick="saveSubject()" class="btn save-btn">Ø­ÙØ¸</button>
      <button onclick="closeSubjectModal()" class="btn cancel-btn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>
<div id="editModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:#000000aa; justify-content:center; align-items:center;">
  <div style="background:#650eb6; padding:20px; border-radius:10px; width:300px; text-align:right;">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©</h3>
    <input type="hidden" id="editId">
    <label for="editName">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
    <input type="text" id="editName" style="width:100%; padding:5px; margin-top:5px;"><br><br>
    <label for="editSection">Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
    <input type="text" id="editSection" style="width:100%; padding:5px; margin-top:5px;"><br><br>
    <button onclick="submitEdit()">Ø­ÙØ¸</button>
    <button onclick="closeEditModal()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>
<script>
    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function openEditModal(id, name, email, section, phone) {
  document.getElementById('editUserId').value = id;
  document.getElementById('editUserName').value = name;
  document.getElementById('editUserEmail').value = email;
  document.getElementById('editUserSection').value = section;
  document.getElementById('editUserPhone').value = phone;

  document.getElementById('editModal').style.display = 'flex';
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('editUserId').value;
  const name = document.getElementById('editUserName').value.trim();
  const email = document.getElementById('editUserEmail').value.trim();
  const section = document.getElementById('editUserSection').value.trim();
  const phone = document.getElementById('editUserPhone').value.trim();

  try {
    const response = await fetch(`http://localhost:5000/api/admin/users/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, section, phone })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.message);

    Toastify({
      text: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",
      duration: 3000,
      gravity: "top",
      position: "center",
      backgroundColor: "#4BB543",
    }).showToast();

    closeEditModal();
    fetchUsers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

  } catch (err) {
    console.error(err);
    alert("ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + err.message);
  }
}); 
</script>
<script>
  const sections = [
    { key: 'math', label: 'Ø´Ø¹Ø¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª' },
    { key: 'science', label: 'Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…' },
    { key: 'eco', label: 'Ø´Ø¹Ø¨Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯' },
    { key: 'tech', label: 'Ø´Ø¹Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©' },
    { key: 'lettres', label: 'Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¢Ø¯Ø§Ø¨' },
    { key: 'info', label: 'Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©' }
  ];

   window.addEventListener('DOMContentLoaded', () => {
    const selector = document.getElementById('sectionSelector');
    selector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>';
    sections.forEach(sec => {
      const option = document.createElement('option');
      option.value = sec.key;       // use the key for API calls
      option.textContent = sec.label;  // show the Arabic label in dropdown
      selector.appendChild(option);
    });

// Load subjects when selection changes
    selector.addEventListener('change', loadSubjectsForSection);
});

  async function loadSubjectsForSection() {
    const section = document.getElementById('sectionSelector').value;
    if (!section) {
      // Clear the table if no section selected
      document.getElementById('subjectsTableBody').innerHTML = '';
      return;
    }

    try {
      const res = await fetch(`http://localhost:5000/api/admin/subjects?section=${encodeURIComponent(section)}`);
      
      if (!res.ok) {
        console.error("HTTP error", res.status);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯');
        return;
      }

      const subjects = await res.json();

      const tbody = document.getElementById('subjectsTableBody');
      tbody.innerHTML = '';

      if (!Array.isArray(subjects) || subjects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©</td></tr>';
        return;
      }

      subjects.forEach((subject, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${subject.name}</td>
          <td>
            <button class="edit-btn" onclick="editSubject(${subject.id}, '${subject.name}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="delete-btn" onclick="deleteSubject(${subject.id})">Ø­Ø°Ù</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error(err);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
    }
  }
</script>
<script>
  const links = document.querySelectorAll('.sidebar ul li a');

  links.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();

      const text = link.textContent.trim();
      const dashboard = document.getElementById('mainDashboard');
      const users = document.getElementById('manageUsersSection');
      const subjects = document.getElementById('manageSubjectsSection');

      // Hide all
      dashboard.style.display = 'none';
      users.style.display = 'none';
      subjects.style.display = 'none';
      document.getElementById('managePaymentsSection').style.display = 'none';

      // Show selected
      if (text === 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©') dashboard.style.display = 'block';
      else if (text === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†') users.style.display = 'block';
      else if (text === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯') subjects.style.display = 'block';
      else if (text === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª') {
      document.getElementById('managePaymentsSection').style.display = 'block';
      loadPendingPayments(); // Load payments when section is shown
      }
    });
  });
</script>
<script>
    const allSubjects = {
      math: ["Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "ÙÙŠØ²ÙŠØ§Ø¡", "Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­ÙŠØ§Ø©", "ÙØ±Ù†Ø³ÙŠØ©", "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©", "ÙÙ„Ø³ÙØ©"],
      science: ["Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©", "ÙÙŠØ²ÙŠØ§Ø¡", "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "ÙØ±Ù†Ø³ÙŠØ©", "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©", "ÙÙ„Ø³ÙØ©"],
      tech: ["ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§", "ÙÙŠØ²ÙŠØ§Ø¡", "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "ÙØ±Ù†Ø³ÙŠØ©", "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©", "ÙÙ„Ø³ÙØ©"],
      eco: ["Ø§Ù‚ØªØµØ§Ø¯", "ØªØµØ±Ù", "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "ÙØ±Ù†Ø³ÙŠØ©", "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©", "ÙÙ„Ø³ÙØ©"],
      lettres: ["Ø¹Ø±Ø¨ÙŠØ©", "ÙÙ„Ø³ÙØ©", "ØªØ§Ø±ÙŠØ®", "Ø¬ØºØ±Ø§ÙÙŠØ§", "ÙØ±Ù†Ø³ÙŠØ©", "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©"],
      info: ["Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©", "Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "ÙÙŠØ²ÙŠØ§Ø¡", "ÙØ±Ù†Ø³ÙŠØ©", "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©", "ÙÙ„Ø³ÙØ©"]
    };

function getSubjectIcon(subject) {
  switch (subject) {
    case "Ø±ÙŠØ§Ø¶ÙŠØ§Øª": return "fas fa-square-root-variable";
    case "ÙÙŠØ²ÙŠØ§Ø¡": return "fas fa-atom";
    case "Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­ÙŠØ§Ø©": return "fas fa-dna";
    case "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§": return "fas fa-microchip";
    case "Ø§Ù‚ØªØµØ§Ø¯": return "fas fa-chart-line";
    case "ØªØµØ±Ù": return "fas fa-briefcase";
    case "Ø¹Ø±Ø¨ÙŠØ©": return "fas fa-feather";
    case "ÙÙ„Ø³ÙØ©": return "fas fa-brain";
    case "ØªØ§Ø±ÙŠØ®": return "fas fa-landmark";
    case "Ø¬ØºØ±Ø§ÙÙŠØ§": return "fas fa-globe-africa";
    case "ÙØ±Ù†Ø³ÙŠØ©": return "fas fa-language";
    case "Ø¥Ù†Ù‚Ù„ÙŠØ²ÙŠØ©": return "fas fa-language";
    case "Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©": return "fas fa-laptop-code";
    default: return "fas fa-book";
  }
}
    function displaySubjects() {
  const section = document.getElementById('section')?.value;
  const container = document.getElementById('subjectsList');
  container.innerHTML = '';

  const subjects = allSubjects[section];
  if (!subjects) {
    container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©.</p>';
    return;
  }

  subjects.forEach(subject => {
    const iconClass = getSubjectIcon(subject);
    const card = document.createElement('div');
    card.className = 'subject-card';
    card.innerHTML = `<i class="${iconClass}"></i><span>${subject}</span>`;
    container.appendChild(card);
  });
}

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }

    function switchView(view) {
      document.getElementById('mainDashboard').style.display = view === 'dashboard' ? 'block' : 'none';
      document.getElementById('manageUsersSection').style.display = view === 'users' ? 'block' : 'none';
      document.getElementById('manageSubjectsSection').style.display = view === 'subjects' ? 'block' : 'none';
      document.getElementById('managePaymentsSection').style.display = 'none';
    }

    window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('userCount').textContent = '124';
  document.getElementById('subjectCount').textContent = '36';
  document.getElementById('videoCount').textContent = '34';
  document.getElementById('quizCount').textContent = '16';

  Toastify({
    text: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù",
    duration: 3000,
    gravity: "top",
    position: "center",
    backgroundColor: "linear-gradient(to right, #6C4AB6, #8D72E1)",
  }).showToast();

  const sectionSelect = document.getElementById('section');
if (sectionSelect) {
  sectionSelect.value = 'math';
  displaySubjects();
} else {
  console.error('Section selector not found!');
}
});
  </script>

  <script>
   async function loadSubjectsForSection() {
    const section = document.getElementById('sectionSelector').value;
    if (!section) return;

    try {
      const res = await fetch(`http://localhost:5000/api/admin/subjects?section=${encodeURIComponent(section)}`);
      const data = await res.json();

      if (!Array.isArray(data)) {
        console.error("API did not return an array");
        return;
      }

      const tbody = document.getElementById('subjectsTableBody');
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©</td></tr>';
        return;
      }

      data.forEach((subject, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${subject.name}</td>
          <td>${subject.section}</td>
          <td>
            <button class="delete-btn" onclick="deleteSubject(${subject.id})">Ø­Ø°Ù</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯:", err);
      alert("âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯");
    }
  }
</script>

<script>
async function deleteSubject(id) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;

  try {
    const res = await fetch(`http://localhost:5000/api/admin/subjects/${id}`, {
      method: 'DELETE',
    });

    const result = await res.json();
    alert(result.message);
    loadSubjectsForSection(); // reload after delete
  } catch (err) {
    console.error('Error deleting subject:', err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©');
  }
}

async function editSubject(id, currentName, section) {
  const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø§Ø¯Ø©:", currentName);
  if (!newName) return;

  try {
    const res = await fetch(`http://localhost:5000/api/admin/subjects/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newName, section })
    });

    const result = await res.json();
    alert(result.message);
    loadSubjectsForSection(); // reload
  } catch (err) {
    console.error('Error editing subject:', err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©');
  }
}
</script>
<script>
  function editSubject(id, name, section) {
    document.getElementById('editId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editSection').value = section;
    document.getElementById('editModal').style.display = 'flex';
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  async function submitEdit() {
    const id = document.getElementById('editId').value;
    const name = document.getElementById('editName').value;
    const section = document.getElementById('editSection').value;

    try {
      const res = await fetch(`http://localhost:5000/api/admin/subjects/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, section })
      });

      const result = await res.json();
      alert(result.message || 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
      closeEditModal();
      loadSubjectsForSection(); // Refresh table
    } catch (err) {
      console.error('Error editing subject:', err);
      alert('ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©');
    }
  }

  async function deleteSubject(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;

    try {
      const res = await fetch(`http://localhost:5000/api/admin/subjects/${id}`, {
        method: 'DELETE',
      });
      const result = await res.json();
      alert(result.message || 'ØªÙ… Ø§Ù„Ø­Ø°Ù');
      loadSubjectsForSection();
    } catch (err) {
      console.error('Error deleting subject:', err);
      alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©');
    }
  }

  function showAddSubjectForm() {
  document.getElementById('addSubjectModal').style.display = 'flex';
}

function closeAddSubjectModal() {
  document.getElementById('addSubjectModal').style.display = 'none';
}

async function createSubject(event) {
    event.preventDefault();

    const name = document.getElementById('newSubjectName').value.trim();
    const section = document.getElementById('newSubjectSection').value;

    if (!name || !section) {
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø©");
      return;
    }

    try {
      const response = await fetch('http://localhost:5000/api/admin/subjects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, section })
      });

      const result = await response.json();

      if (!response.ok) {
        console.error("ğŸš¨ Server returned an error:", result);
        throw new Error(result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
      }

      alert(result.message || 'âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
      closeAddSubjectModal();
       await loadSubjectsForSection();
      document.getElementById('newSubjectName').value = '';
      document.getElementById('newSubjectSection').value = '';
    } catch (err) {
      console.error("âŒ Frontend error:", err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©: " + err.message);
    }
  }
</script>
<script>
const API_BASE = 'http://localhost:5000/api/admin';
const token = localStorage.getItem('token');

async function loadPendingPayments() {
  const tbody = document.getElementById('admin-payments-body');
  tbody.innerHTML = `<tr><td colspan="8" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;

  try {
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('No authentication token found');
    }

    const response = await fetch(`${API_BASE}/payments`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch payments');
    }

    const payments = await response.json();

    if (!payments || payments.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹</td></tr>`;
      return;
    }

    tbody.innerHTML = ''; // Clear loading message

    payments.forEach((payment, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>
  ${payment.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br>
  <small>${payment.email || ''}</small>
</td>
        <td>${payment.amount} Ø¯.Øª</td>
        <td>${payment.method || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
        <td>${payment.reference || 'â€”'}</td>
        <td>${new Date(payment.createdAt).toLocaleString('ar-TN')}</td>
        <td class="payment-status-${payment.status}">
          ${getStatusText(payment.status)}
        </td>
        <td>
          ${payment.status === 'pending' ? `
            <button class="btn-success" onclick="confirmPayment(${payment.id})">ØªØ£ÙƒÙŠØ¯</button>
            <button class="btn-danger" onclick="refusePayment(${payment.id})">Ø±ÙØ¶</button>
          ` : 'â€”'}
        </td>
      `;
      tbody.appendChild(row);
    });

  } catch (error) {
    console.error('Error loading payments:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center;color:#e74c3c">
          Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}
        </td>
      </tr>
    `;
  }
}

function getStatusText(status) {
  switch(status) {
    case 'pending': return 'ğŸ•“ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
    case 'success': return 'âœ… Ù…ÙƒØªÙ…Ù„';
    case 'refused': return 'âŒ Ù…Ø±ÙÙˆØ¶';
    default: return status;
  }
}
async function confirmPayment(paymentId) {
  const confirmBtn = document.querySelector(`button[onclick="confirmPayment(${paymentId})"]`);
  const originalText = confirmBtn.innerHTML;
  
  try {
    // Show loading state
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    confirmBtn.disabled = true;

    const response = await fetch(`${API_BASE}/payments/${paymentId}/confirm`, {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      }
    });

    const result = await response.json();

    if (!result.success) {
      throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹');
    }

    // Show success message with verified balance
    Toastify({
      text: `âœ… ${result.message} | Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${result.newBalance} Ø¯.Øª`,
      duration: 5000,
      backgroundColor: "#4BB543",
      className: "toastify-success"
    }).showToast();

    // Refresh payments list
    loadPendingPayments();

    // If on user dashboard, update wallet display
    if (typeof updateWalletDisplay === "function") {
      updateWalletDisplay(result.newBalance);
    }

  } catch (err) {
    Toastify({
      text: `âŒ ${err.message}`,
      duration: 5000,
      backgroundColor: "#e74c3c",
      className: "toastify-error"
    }).showToast();
  } finally {
    confirmBtn.innerHTML = originalText;
    confirmBtn.disabled = false;
  }
}

async function refusePayment(paymentId) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) return;
  
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const response = await fetch(`${API_BASE}/payments/${paymentId}/refuse`, {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'ÙØ´Ù„ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹');
    }

    const data = await response.json();
    
    Toastify({
      text: data.message || 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­',
      duration: 3000,
      backgroundColor: "#f39c12"
    }).showToast();

    loadPendingPayments();

  } catch (err) {
    console.error('Error refusing payment:', err);
    Toastify({
      text: `Ø®Ø·Ø£: ${err.message}`,
      duration: 3000,
      backgroundColor: "#e74c3c"
    }).showToast();
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  // Other initialization code...
  
  // Check if we're on the payments section
  if (window.location.hash === '#payments') {
    document.getElementById('managePaymentsSection').style.display = 'block';
    loadPendingPayments();
  }
});
</script>

</body>
</html>
